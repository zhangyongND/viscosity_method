% Thank Bogdan for this template :-)

\documentclass[12pt]{article}
%\documentclass[12pt,prb,preprint]{revtex4}

\setlength{\textwidth}{6.5in} % sets width of text to 6.5 in
\renewcommand{\baselinestretch}{1.5} % double space; {1} for single space
\textwidth 6.5in % default width = 5.5 in; def margins 1.5 in
\setlength{\evensidemargin}{0.0 cm}
\setlength{\oddsidemargin}{0.0 cm} % {1.0 in} shifts text right 1 in

\textheight 8.5 in % sets height of text to 8.5 in
\topmargin -0.0 in % sets top margin 0.1 in above def (2 in)


%------------------
\title{Reliable Viscosity from Equilibrium Molecular Dynamics Simulations: A Time Decomposition Method}
\author{Yong Zhang, Akihito Otani and Edward J. Maginn\thanks{Corresponding author. E-mail: ed@nd.edu} \\
                Department of Chemical and Biomolecular Engineering\\
                University of Notre Dame\\
                Notre Dame, Indiana, 46556 USA}
%\renewcommand{\thefootnote}{\fnsymbol{footnote}}
%-----------------


\date{\today}
\usepackage[dvips]{graphicx}
%\usepackage{graphicx}
\usepackage{overcite}
\usepackage{longtable}
\usepackage{supertabular}

\begin{document}
\pagenumbering{arabic}
%\baselineskip 0.9 cm

\maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\begin{abstract}

A viscosity calculation method based on Green-Kubo relation
and equilibrium molecular dynamics simulation was proposed.
In this method,
instead of one long trajectory usually used in such calculation,
multiple trajectories are generated.
The Green-Kubo relation is applied to each trajectory,
the averaged running integral as a function of time is fitted to a double exponential function
with the weighting function derived from the standard deviation of the running integrals.
Such a weighting function guarantees the accuracy of the fit even at long times,
avoids the well known long time tail problem.
In practice, however, to save computational time,
short correlation time is preferred and
a cutoff time $t_{cut}$ is suggested,
which can be determined by the relative values of the running integral and the corresponding standard deviation.
%The number and length of the independent trajectories can be determined with simple tests.
All simulation parameters can be determined by following objective standards,
guarantees the results to be reliable and reproducible.
The method was demonstrated by applying to relative low viscosity liquid ethanol and 
relatively high viscosity ionic liquid 1-n-butyl-3-methylimidazolium bis(trifluoromethane-sulfonyl)imide ($[BMIM][Tf_2N]$),
and found to be robust.
\newline

Keywords: Green-Kubo, Ionic Liquids, standard deviation, system size effect

\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Introduction}

There have been a number of different atomistic simulation methods developed for computing the shear viscosity of liquids {\bf Give some classic references: Original Green-Kobo papers, SLLOD papers, review paper from Peter Cummings, RNEMD Muller-Plathe, MIR Arya and Maginn - J. Chem. Phys., Vol. 113, No. 6}.
\cite{
Cummings.IECR.31.1237.1992,	% review
Margulis.ACR.40.1097.2007,	% review
Mu.JML.193.262.2014,		% review
Hummer.JPCB.108.15873.2004,	% size effect
Margulis.JPCB.111.4705.2007,	% NEMD
Maginn.JPCB.111.4867.2007,	% NEMD
Borodin.JPCB.113.4771.2009,	% NEMD & EMD
Mejia.JML.186.106.2013,		% CG
Atilhan.IECR.52.16774.2013,	% eta ~ Eint/Vm
Llovell.JPCB.117.8159.2013,	% free volume
Lee.JPCB.118.2712.2014,		% free volume
Yethiraj.JPCL.5.2670.2014	% SAPT
}
Due to its simplicity, 
the Green-Kubo relation based on equilibrium molecular dynamics (MD) simulations is perhaps the most widely used method. {\bf cite}. 
%\cite{}

In the Green-Kubo approach,
the shear viscosity is calculated from the integral over time of the pressure tensor autocorrelation function 
\cite{ComputerSimulationOfLiquids}
\begin{equation}
{\eta = {V \over k_B T } \int_0 ^{\infty}{\langle P_{\alpha\beta}(t) \cdot P_{\alpha\beta}(0) \rangle \ dt} }
\label{eq:gk}
\end{equation}
where $V$ is the system volume,
$k_B$ is the Boltzmann constant,
$T$ is temperature, and 
$P_{\alpha\beta}$ denotes the element $\alpha\beta$ of the pressure tensor.
Theoretically,
the pressure tensor autocorrelation function decays to zero in the long time limit
and the integral in eq~\ref{eq:gk} will reach a constant value,
which corresponds to the calculated shear viscosity.
In practice, however, 
due to the well known long time tail in such correlation functions,
\cite{Verlet.PRA.7.1690.1973}
the integral does not necessarily converge to a constant value, but instead shows fluctuations at long times due to the accumulation of random noise from the correlation function. 
Figure~\ref{fig:visc-longtraj} shows an example in which the running integrals using eq~\ref{eq:gk} are calculated from three independent trajectories generated for ethanol at 298 K. 
Each trajectory is 10 nanosecond (ns) long.
It can be seen that the three curves start to deviate from one another in less than 100 picosecond (ps)
and reach dramatically different values at 1 ns.

The curves shown in Figure~\ref{fig:visc-longtraj} were evaluated by taking averages over the six independent components of the pressure tensor. \cite{Evans.JCP.100.541.1994,Hess.JCP.116.209.2002} Unlike self-diffusivity which is a single particle property,
viscosity is a collective property and 
the statistics cannot be improved by averaging over all particles in the system. This means that a very long trajectory is needed to obtain good statistics.
An alternative strategy is to run multiple independent trajectories and take the average of the running time integrals.
\cite{Gasser.JCP.136.094501.2012,
Bala.JCED.59.3061.2014}
This saves ``wall clock" time and is relatively easy to implement, given the availability of massively parallel computation facilities.
In Figure~\ref{fig:visc-longtraj},
the average of the three individual curves are also provided
and it is clear that the average integral is smoother than the individual ones, especially at short times.

In practice, the shear viscosity must be estimated from a finite time ``plateau" region of the integral, but the identity of the plateau region can be arbitrary. For example, in the curve calculated from one trajectory (traj 1) shown in Figure~\ref{fig:visc-longtraj},
the region between 100 $\sim$  200 ps might be a plateau region,
but the region around 300 ps could also be considered a reasonable option.
It is even harder to define the plateau region in the other two curves (traj 2 and traj 3).
Assuming a plateau is somehow identified,
it is still  not clear how to unambiguously determine the viscosity.
Different procedures have been reported in the literature.
One way is to take the value of the integral at a chosen cutoff time.
Zhang and Nie \cite{Nie.PCM.27.164.2000} set the cutoff to the time when the autocorrelation function first reaches zero 
in their study of liquid iron. 
A similar idea was also used in an earlier work by Alfe and Gillan \cite{Alfe.PRL.81.5161.1998}
in the study of liquid aluminum and iron-sulfur alloy.
However, it has been pointed out that such a definition of cutoff time can be misleading 
because the zero crossing time is mainly the result of statistical fluctuations
which depend on the calculation details.
\cite{Gasser.JCP.136.094501.2012}
In their study of liquid tin,
Gasser and coworkers applied a cutoff time of 2ps without justification.
A much longer cutoff time, up to 5 ns, was applied by Mondal and Balasubramanian in their recent study of ionic liquid (IL) systems,
\cite{Bala.JCED.59.3061.2014}
which seems to be the longest possible time from their correlation function.
Instead of taking a value at certain cutoff time, 
other groups have taken an average value over a region in the running integral.
\cite{Smit.JCP.131.246101.2009,
Kazandjian.PRE.85.066701.2012}
However, all these procedures are somewhat arbitrary and
the results from different procedures can yield quite different viscosities.

A more systematic way to obtain the shear viscosity from the Green-Kubo relation
is to fit either the pressure tensor autocorrelation function 
or the running integral in eq~\ref{eq:gk} to a function
and compute the viscosity in the long time limit analytically.
The Kohlrausch law has been used to fit the autocorrelation function.
\cite{Zhang.MP.100.2617.2002,
Meyer.PRE.90.043101.2014}
To fit the running integral,
a double exponential function of the form 
\begin{equation}
{\eta(t) = A\alpha\tau_1(1-e^{-t/{\tau_1}}) + A(1-\alpha)\tau_2(1-e^{-t/{\tau_2}}) }
\label{eq:visc_fit}
\end{equation}
has been suggested 
where $A, \alpha, \tau_1 \ and \ \tau_2$ are fitting parameters.
\cite{Hess.JCP.116.209.2002,
Rey-Castro.JPC.B.110.14426.2006}
To reduce the noise at long times,
Rey-Castro and Vega applied a weighting factor of $1/t^2$ in the fitting.
\cite{Rey-Castro.JPC.B.110.14426.2006}

Despite these developments, the reliable calculation of shear viscosity from a Green-Kubo integral is still a challenging task. First, the methods used in the literature for estimating the long time limit of the integral are arbitrary and depending on the data analysis procedure used, different shear viscosities can be obtained for exactly the same system. Second, it is not clear from these approaches how one determines when a converged value of the shear viscosity is obtained. This problem is exacerbated for high viscosity liquids, where statistics are usually poor within accessible simulation time scales. Ionic liquids (ILs) are an examples of this kind of high viscosity liquid. ILs are defined as salts with melting points below 100 $^\circ$C.
Due to their unique properties such as low vapor pressure, large liquid phase range and nonflammibility,
ILs have been extensively studied for several industrial uses. {\bf Add earlier references}. 

In the current work, we introduce a time-decomposition method for the reliable calculation of shear viscosity 
from equilibrium MD simulations. The method provides an objective means of computing shear viscosity from MD trajectories, thereby eliminating the subjective variability inherent in previous approaches. The method also minimizes uncertainties due to the long time tail of the pressure tensor autocorrelation function.
The procedure is demonstrated by applying to a low viscosity molecular solvent ethanol and relatively high viscosity IL, 
1-n-butyl-3-methylimidazolium bis(trifluoromethane-sulfonyl)imide ($[BMIM][Tf_2N]$).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Simulation Procedure and Details}

\subsection{Molecular Dynamics Simulation}

Equilibrium MD simulations were carried out using the LAMMPS package. \cite{lammps}
For both ethanol and $[BMIM][Tf_2N]$,
the general Amber force field (GAFF) \cite{Case.JCC.25.1157.2004}
was used to describe the inter- and intramolecular interactions.
To derive the partial charges,
the structure of the ethanol molecule or each isolated ion in $[BMIM][Tf_2N]$ was optimized at the B3LYP/6-311++g(d,p) level
using the Gaussian 09 package.
\cite{g09}
The atomic charges were then derived by fitting the electrostatic potential surface
using the RESP method.
\cite{RESP}
The charges obtained this way were directly used for ethanol.
For $[BMIM][Tf_2N]$, the charges were uniformly scaled by 0.8 to account for the effect of charge transfer and polarizability.
\cite{Maginn.JPCB.116.10036.2012}
The long range electrostatic interactions were calculated using the particle-particle particle-mesh (PPPM) method\cite{pppm}
with real space cutoff of 12 \AA.
For all simulations,
a time step of 1 femtosecond (fs) was used and the periodic boundary conditions were applied in all directions.
The simulation box was built up by putting molecules randomly in a cubic box using the package Packmol.
\cite{Martinez.JCC.24.819.2003,
Martinez.JCC.30.2157.2009}
The ethanol box contained 1000 molecules and the $[BMIM][Tf_2N]$ system contained 300 ion pairs, respectively.
The systems were then equilibrated for 2ns in the isothermal-isobaric (NPT) ensemble
followed by canonical (NVT) ensemble production runs.
The pressure tensor components were saved every 5 fs during the NVT simulation.
The Nos\'e-Hoover thermostat
\cite{Nose-Hoover.PRA.31.1695.1985}
and the extended Lagrangian approach
\cite{Shinoda.PR.B.69.134103}
were applied to control the temperature and pressure, respectively.
Simulations were carried out at five temperatures (283, 298, 303, 323, and 343 K, respectively) for ethanol
and four temperatures (350, 400, 450 and 500 K, respectively) for $[BMIM][Tf_2N]$.
The pressure was fixed at one atmosphere in all constant pressure simulations
with isotropic volume fluctuations.


\subsection{Time-Decomposition Method for Viscosity Calculation}

The shear viscosity was calculated by following procedure.

(1) Generate N independent NVT trajectories at a given temperature;

(2) For each trajectory, calculate the shear viscosity based on the Green-Kubo relation (eq~\ref{eq:gk});

(3) Calculate the average of the running integrals over N trajectories and the standard deviation,
which is a function of time:
\begin{equation}
{\sigma(t) = \sqrt{ {1 \over {N-1}} \sum_{i=1}^{N} {(\eta(t)_i - \langle \eta(t) \rangle)^2} } }
\label{eq:std_err}
\end{equation}

(4) Fit the standard deviation to a power law function
\begin{equation}
{\sigma(t)=At^b}
\label{eq:power}
\end{equation}

(5) Fit the averaged running integral by the double exponential function (eq~\ref{eq:visc_fit}) 
for the time period up to $t_{cut}$ with the weight $1/t^b$,
where $b$ is the fitting result from step (4) and $t_{cut}$ can be decided from the relation between $\eta$ and $\sigma(t)$.
We found that the time when $\sigma(t)$ is about 40\% of the average $\eta$ is a good choice. 
Take the long time limit of the fitted double exponential function as the calculated viscosity;

(6) Increase N and repeat steps (1)-(5) until the change in the calculated viscosity in step (5) from previous cycle is smaller than a tolerance.

Details of this time-decomposition procedure are described in the next section.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results and Discussions}

\subsection{Density}

The density as a function of temperature was calculated for each system from the NPT ensemble simulations.
The results are shown in Figure~\ref{fig:density} and compared with experimental values.
For ethanol, the calculated densities were found to be about 2.5\% higher than experimental results.
For $[BMIM][Tf_2N]$, 
simulations were carried out at relatively high temperatures for faster dynamics and better sampling.
The calculated densities at high temperatures were fitted to a linear function and extrapolated to low temperatures.
As shown in the figure, 
the agreement with experimental results are almost perfect.
Given that the calculated densities agree with experimental results very well, the force fields were then used without modification to compute viscosities for the two liquids. 

\subsection{Viscosity of Ethanol}

\subsubsection{Weighting Function}

In order to calculate the viscosity,
100 independent trajectories were generated starting from the same configuration but a different random seed for initial velocity assignment.
Each trajectory was 5 ns long.
The first 1 ns of each trajectory was considered equilibration and ignored in the viscosity calculation.
Based on each trajectory, 
the shear viscosity was calculated via eq~\ref{eq:gk} 
and the average at each temperature is shown in Figure~\ref{fig:ethanol-ave} (top panel).
As opposed to the noisy curves in Figure~\ref{fig:visc-longtraj},
the curves obtained from averaging over 100 independent trajectories are much better behaved.
In each case, following a sharp increase at short time,
the running integral reaches a flat region.
However, even with the average of 100 independent trajectories,
the random error in the correlation function is not fully canceled out and the curves are not completely flat,
especially at long times.
The standard deviations based on eq~\ref{eq:std_err} are calculated and shown in Figure~\ref{fig:ethanol-ave} (bottom panel).
As expected, the standard deviation increase as the time becomes longer due to the accumulation of random noise from the long time tail in the correlation function.
\cite{Verlet.PRA.7.1690.1973}
At each temperature,
the standard deviation was fit to a power law function $\sigma(t) = At^{b}$ (eq~\ref{eq:power}) 
where $t$ is time, $A$ and $b$ are fitting parameters.

In order to compute the viscosity,
the averaged running integral was fit to the double exponential function (eq~\ref{eq:visc_fit}).
\cite{Rey-Castro.JPC.B.110.14426.2006}
We realized that the $1/t^2$ weighting function decays too fast 
so that for systems with high viscosity, 
the weight becomes negligible before reaching the plateau region
and the viscosity is significantly underestimated. Instead of weighting the data by $1/t^2$ as was done by Rey-Castro and coworkers,
\cite{Rey-Castro.JPC.B.110.14426.2006}
the results were fit with a weighting function $1/t^b$ where $b$ is found by fitting the standard deviation using eq~ \ref{eq:power}.
With this weighting function,
the short time data points that have higher accuracy have more weight in the fitting
and the less accurate data points at long times have less weight.
Note that the way the weighting function is determined guarantees 
that each data point used in the fit contributes the same error to the final result
even when long time data points are included.

\subsubsection{Cutoff Time $t_{cut}$}
While the fitting procedure described above is accurate in the limit of long times, in practice one would like to minimize the amount of simulation time required to obtain an accurate viscosity for the sake of reducing computational cost.
Therefore, a parameter $t_{cut}$ was introduced to characterize the lower time limit that the fit is applied to.
It was found empirically that the time at which the calculated standard deviation $\sigma(t)$ was about 40\% of the corresponding viscosity
(rough average of the flat region in the running integral) was a good choice for $t_{cut}$.
For example, for the results shown in Figure~\ref{fig:ethanol-ave} (top panel),
at 298 K, the flat region of the running integral has a viscosity value of 1.3 cP,
40\% of which is 0.52 cP, which corresponds to a $t_{cut} = 700 ps$ based on the $\sigma$ values shown in Figure~\ref{fig:ethanol-ave} (lower panel).
A complication arises when fitting the data at very short times, due to the fact that the running integral fluctuates a great deal because of the fast decay of the correlation function. This can be seen in Figure~\ref{fig:ethanol-2ps}, where large fluctuations in the integral for ethanol at times less than 2 ps are evident.
Because of the large weight of this period of time,
such fluctuations make the fitting unstable.
Therefore, the first 2ps of the running integral was ignored in the fitting.
With these considerations,
Figure~\ref{fig:ethanol-fit} shows the fitting results of ethanol at 298 K.
The calculated standard deviation and the corresponding fitting results are provided in the inset.
The $b$ parameter was found to have a value of 0.52,
which is close to the observation by Danel, Kazandjian and Zerah,
\cite{Kazandjian.PRE.85.066701.2012}
who reported that the calculated standard deviation varies roughly like $\sqrt{t}$.
Based on the double exponential fitting to the running integral with weight of $1/t^{0.52}$,
the viscosity was found to be 1.318 cP,
which is close to experimental values $\sim$ 1.1 cP.
\cite{Jouyban.KJCE.29.812.2012,
Nain.JML.140.108.2008,
Bhuiyan.JML.138.139.2008,
Fonseca.JCED.52.1240.2007,
Taboas.JCED.51.940.2006,
Tojo.JCED.49.1590.2004}
It is worth mentioning that the computed viscosity for ethanol at 298 K is insensitive to the value of $t_{cut}$ over a very wide range. For example, if $t_{cut}= 200 ps$ 
where $\sigma$ has a value of about 20\% of viscosity, the calculated shear viscosity is 1.312 cP, nearly identical to that when $t_{cut} = 700 ps$.
When $t_{cut} = 2000 ps$, the shear viscosity is still within 2\% of the value obtained with a shorter cutoff time. These results are consistent with the fact that the applied weighting function properly minimizes the error even when more of the noisy long time region is included in the fitting.

The viscosities at other temperatures were derived by following the same procedure,
and the results are shown in Figure~\ref{fig:ethanol-visc} (top panel) and compared with available experimental values.
There are small deviations in the experimental values,
but overall,
the agreement between the calculated and experimentally measured viscosities is excellent.
At each temperature,
the $b$ parameters were found to be between 0.41-0.56.
For comparison, the weighting function $1/t^{0.5}$ was also used for all temperatures 
and the calculated viscosities agree with those using $1/t^b$ very well,
as shown in the lower panel in Figure~\ref{fig:ethanol-visc}.

\subsubsection{Number of Trajectories}

The above results were all obtained using 100 independent trajectories to demonstrate the general calculation procedure.
In fact, very accurate results could be obtained with far fewer than 100 independent trajectories. This is the strength of the proposed time decomposition method; one can start by running a small number of independent trajectories and then increase the number of trajectories until the desired level of accuracy is obtained. 
The top left panel in Figure~\ref{fig:ethanol-num} shows the cumulative average of up to 100 trajectories.
The top right panel in the figure shows the corresponding standard deviation.
The calculated standard deviation at four time points are explicitly provided in the lower left panel of the figure.
As shown in the plots,
both the averaged running integral and standard deviation converged with about 30-40 trajectories.
Following the procedure described above,
the viscosities as a function of number of trajectories were calculated 
and are provided in the lower right panel of Figure~\ref{fig:ethanol-num}.
With 40 or more trajectories,
the calculated viscosities were found to deviate less than 1\%  from each other,
indicating the convergence of the simulations.
The results with the $1/t^{0.5}$ weighting were also provided for comparison,
and the resulting viscosities agree with those obtained using the $1/t^b$ weighting function almost perfectly.

\subsubsection{Trajectory Length}
In addition to minimizing the number of independent trajectories required for a given level of accuracy, one would also like to minimize the length of the trajectories. 
Using only the last 500 ps, 1 ns or 2 ns from the 5 ns trajectories at 298 K,
the viscosities were calculated and the results are shown in Figure~\ref{fig:ethanol-length}
and compared with results using 4 ns trajectories.
As expected, the calculated standard deviation becomes larger when shorter trajectories are used.
Using the same criteria that the viscosity is about 40\% of standard deviation,
the cutoff time $t_{cut}$ was found to be 400 ps when 2 ns trajectories were used,
200 ps when 1 ns trajectories were used, 
and 90 ps when 500 ps trajectories were used, respectively.
Using either 1 or 2 ns trajectories,
as shown in the lower panel of Figure~\ref{fig:ethanol-length},
the calculated viscosities still converge with 40 trajectories
although the fluctuations are larger than the results when 4 ns trajectories were used
(but still within 1-2\% from each other).
In either case, the results are within 2-3\% deviation from those using 4 ns trajectories.
It is interesting to note that the viscosities calculated from the 1 ns trajectories are lower than those obtained from the 4 ns trajectories, 
whereas viscosities from the 2 ns trajectories are higher than those from the 4 ns trajectories.
The randomness of the deviation indicates that even 1 ns trajectories are long enough in this case to obtain accurate viscosities.
However, with only 500 ps trajectories,
the running integral does not really reach a flat region (top panel).
The calculated viscosities do not seem to converge either even with 100 trajectories,
indicating that 500 ps is too short for the calculation of a reliable viscosity in this case. Using the procedure described here, it is readily apparent that the 500 ps trajectories are too short and that longer simulations are necessary to get reasonable accuracy. 

\subsubsection{System Size Effect}

The effect of simulation system size was also studied.
In addition to the 1000 ethanol molecule box,
a smaller box with 500 molecules and a bigger box with 1500 molecules were setup
and simulations were carried out following the same procedure.
The calculated running integral and standard deviation from 100 trajectories are shown in Figure~\ref{fig:ethanol-boxsize}.
As shown in the plots,
the calculated standard deviation are almost the same for the three systems with different sizes.
The derived viscosities are also within 1\% of each other,
consistent with previous reports regarding system size effects on viscosity.
\cite{Alfe.PRL.81.5161.1998,
Hummer.JPCB.108.15873.2004,
Andreussi.JCP.137.044508.2012}

\subsection{Viscosity of $[BMIM][Tf_2N]$}

The same procedure was applied to $[BMIM][Tf_2N]$,
which has a much higher viscosity than ethanol at room temperature.
To accelerate the dynamics, 
the simulations were carried out at high temperatures between 350 and 500 K with 50 K intervals.
As was done with ethanol,
100 independent trajectories were generated at each temperature.
The trajectories were 7 ns long at 350 K and 5 ns long at other temperatures.
The first 1 ns was ignored in each trajectory and the pressure tensor autocorrelation function
was calculated over the remaining part of the trajectories.
The averaged running integral and the corresponding standard deviation at each temperature
are shown in Figure~\ref{fig:bmim-ave}.
The standard deviations were fit to the same power law function $\sigma(t)=A t^b$
and the parameters $b$ were found to have values between 0.60-0.73,
slightly higher than those of ethanol.
Again, the cutoff time $t_{cut}$ was determined by taking the time at which
the calculated standard deviation is about 40\% of the viscosity value at each temperature.
The $t_{cut}$ was found to be 1100, 800, 800 and 700 ps at 350, 400, 450 and 500 K, respectively.
Values of the standard deviation that are lower than 40\% of the viscosity could be used at each temperature, as long as the results do not change much.
For example, at 350 K, 
with a 30\% cutoff,  $t_{cut}$ was found to be 800 ps and the calculated viscosity was only 0.8\% lower than when a 40\% cutoff was used.
If a cutoff of 20\% was used, however, the calculated viscosity becomes 6.1\% lower.
For liquids with lower viscosity such as ethanol discussed above or $[BMIM][Tf_2N]$ at higher temperature,
cutoffs lower than 30\% could be safely used.
For liquids with viscosities even higher than the IL studied here, 
it was found that a 40\% cutoff is still a good option (results not shown here). For these reasons, a consistent 40\% cutoff values was used in the current work.
Similar to ethanol,
large fluctuations were observed in the first 2 ps of the running integral (as shown in the bottom panel in Figure~\ref{fig:bmim-ave})
so the first 2 ps was ignored in the fitting.

The calculated viscosities for $[BMIM][Tf_2N]$ as a function of temperature are shown in Figure~\ref{fig:bmim-visc}.
To compare with the experimental results at relatively low temperature,
the calculated viscosities were fitted to
the Vogel-Tamman-Fulcher (VTF) equation
\cite{VTF}
\begin{equation}
{\eta = A exp(B/(T-T_0))  }
\label{eq:VTF}
\end{equation}
and extrapolated to experimental temperatures.
In the above equation,
$A$, $B$ and $T_0$ are fitting parameters.
The fitting results are shown as a dashed line in Figure~\ref{fig:bmim-visc}.
As shown in the figure,
the extrapolated viscosities are systematically higher than experimental results.
\cite{Gadzuric.JCED.57.1072.2012,
Katsuta.JCED.55.1588.2010,
Watanabe.JPCB.110.19593.2006,
Majer.GC.8.172.2006,
Watanabe.JPCB.109.6103.2005,
VanderNoot.JEC.568.167.2004}
In order to compare simulation and experimental viscosity results, the experimental data were fit to the VTF equation and  
extrapolated to the simulation temperature range.
The results are shown in Figure~\ref{fig:bmim-visc}.
Overall, the simulated viscosities agree reasonably well with extrapolated experimental data. Note that one could also fit the simulation data to the VTF equation and extrapolate to lower temperatures, but because there are only four simulation data points to fit three parameters in the VTF equation, 
the extrapolated results include too large of an uncertainty to be reliable.

Similar to the case of ethanol,
more than enough trajectories (both number and length of trajectories) were generated
to demonstrate the viscosity calculation of $[BMIM][Tf_2N]$.
Figure~\ref{fig:bmim-num} shows the calculated viscosities of $[BMIM][Tf_2N]$ as a function of number of trajectories at 350 K.
With 30 or more trajectories,
the calculated viscosities are within 2-3\% of each other.
For comparison,
the weighting function $1/t^{0.5}$ was also applied and the results are shown in the same plot.
The results using $1/t^{0.5}$ as a weighting function are systematically higher than the results using $1/t^b$ by 2-3\%.
This difference is large relative to the almost perfect agreement in the case of ethanol,
likely due to the larger $b$ parameters derived for $[BMIM][Tf_2N]$.
However, considering the deviation from experimental results,
these differences are negligible. This suggests that if one has not performed the necessary test runs to estimate the parameter $b$, the 
$1/t^{0.5}$ weighting function can be used without introducing significant error.

Finally we note that for high viscosity liquids, it is very important to use a reasonable form of the weighting function when fitting eq~\ref{eq:visc_fit} to the running integral. For example, Figure~\ref{fig:t2weight} shows a comparison of the viscosities of [BMIM][Tf$_2$N] at 350 K estimated using the  $1/t^2$  and the $1/t^b$ weighting. Use of the $1/t^2$ weighting function severely underestimates the viscosity, while the milder weighting function proposed here gives a much more reasonable fit to the simulation data. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Concluding Remarks}

Equilibrium MD simulation is a popular technique 
for the calculation of viscosity due to its simplicity
and the fact that the generated trajectories can also be used to compute other system properties,
something that can't be done with non-equilibrium MD methods.
The traditional data analysis methods used to compute the shear viscosity from equilibrium MD simulations and Green-Kubo integrals 
suffer from a certain level of arbitrariness,
making calculated results unreliable and difficult to reproduce. In the current work,
a time-decomposition method is proposed for the calculation of viscosity from equilibrium MD simulations along with an objective method for estimating the viscosity.

The proposed method decomposes one long equilibrium MD trajectory into multiple independent short ones.
The Green-Kubo relation is applied to each of the short trajectories
and the averaged running integral is used to derive the viscosity.
The standard deviation in the individual running integrals is also calculated and fitted to a power law function,
which is used as weighting function in the fit to a double exponential function of the averaged running integral.
The standard deviation is also used to decide the time range (characterized by $t_{cut}$) 
during which the running integral is fitted.
The necessary number of independent trajectories and the length of each trajectory, which will depend upon the nature of the system, can be easily decided with a few test runs.
The proposed procedure was applied to ethanol and the ionic liquid $[BMIM][Tf_2N]$,
and the viscosities of these two liquids were reliably calculated over a range of temperatures. Heuristics were developed that enable the viscosities to be estimated from the trajectories without reliance on subjective estimates made by the user. 

For the two examples discussed in the current work,
the calculated viscosities agree with experimental measurement reasonably well.
However, it should be understood that the focus in the current work is to demonstrate the viscosity simulation procedure
rather than to show how closely the simulations can match experimental data. 
Therefore, the focus of the paper was to compare calculated results for well-defined models using different analysis options.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\vspace{7 mm}
{\bf\Large Acknowledgment}

This material is based upon work supported by
the U.S. Department of Energy, Basic Energy Science, Joint Center for Energy Storage Research under Contract No. DE-AC02-06CH11357. 
Computational resources were provided by the National Energy Research Scientific Computing Center,
which is supported by the Office of Science of the U.S. Department of Energy under Contract No. DE-AC02-05CH11231,
and the Center for Research Computing (CRC) at the University of Notre Dame.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%--------ref---------------
\newpage
\clearpage

\bibliographystyle{jpc_new}
%\bibliographystyle{proteins}
%\bibliographystyle{achemso}
%\bibliographystyle{jcp}
\bibliography{paper}


%%%%%%%%%%%%%%%%%%%%%%%%%%% tables


%%%%%%%%%%%%%%%%%%%%%%%%%%% figures

\newpage
\clearpage
{\bf\Large Figure captions}
\vspace{7 mm}

Figure~\ref{fig:visc-longtraj}.
Example results of viscosity calculations using the Green-Kubo relation 
based on three independent 10 ns trajectories generated for ethanol at 298 K.
Due to the well known long time tail in the pressure autocorrelation function,
the three running integrals deviate in less than 100 ps and end up at significantly different values at 1 ns,
which makes it very difficult to derive a reliable viscosity from such calculation.
The average of the three running integral is also provided in the plot, 
which is much smoother than each individual one.

Figure~\ref{fig:density}.
Calculated densities as function of temperature and compared with experimental results.
Upper panel: ethanol, 
experimental results: 
Exp. a, ref~\cite{Jouyban.KJCE.29.812.2012};
Exp. b, ref~\cite{Bhuiyan.JML.138.139.2008};
Exp. c, ref~\cite{Fonseca.JCED.52.1240.2007};
Exp. d, ref~\cite{Taboas.JCED.51.940.2006};
Exp. e, ref~\cite{Tojo.JCED.49.1590.2004}.
Lower panel: $[BMIM][Tf_2N]$,
experimental results: 
Exp. a, ref~\cite{Gadzuric.JCED.57.1072.2012};
Exp. b, ref~\cite{Katsuta.JCED.55.1588.2010};
Exp. c, ref~\cite{Watanabe.JPCB.110.19593.2006};
Exp. d, ref~\cite{Majer.GC.8.172.2006};
Exp. e, ref~\cite{Heintz.JCED.53.596.2008};
Exp. f, ref~\cite{Husson.JCED.52.2204.2007}.
The calculated densities at high temperature were fitted to a linear function and extrapolated to lower experimental temperature range
(shown as dotted line).
For both ethanol and $[BMIM][Tf_2N]$,
the calculated densities agree with experimental results very well.


Figure~\ref{fig:ethanol-ave}.
The calculated averaged running integral (eq~\ref{eq:gk})
and standard deviation (eq~\ref{eq:std_err}) 
from 100 independent 5 ns long equilibrium MD trajectories for ethanol at different temperatures.

Figure~\ref{fig:t2weight}.
Example results of fitting the running integral to the double exponential function (eq~\ref{eq:visc_fit}) with a $1/t^2$ weight.
The running integral is averaged over 100 independent trajectories generated for $[BMIM][Tf_2N]$ at 350 K,
each trajectory is 7 ns long.
The weighting function decays too fast and the fitting result significantly underestimates the contribution from long time scales.
A weighting function of the form $1/t^b$ is suggested in this work,
where $b$ is derived by fitting the calculated standard deviation to a power function $\sigma(t) = Ae^b$,
which was found to work well even for high viscosity liquid.

Figure~\ref{fig:ethanol-2ps}.
The large fluctuation at very short time in the calculated running integral of ethanol.
Each curve is an average over 100 independent ones.
The same fluctuation is also seen in each individual curve (not shown).
This fluctuation behavior makes the fitting unstable due to the heavy weight in this time range.
The first 2 ps of the running integral was therefore ignored in the fitting.

Figure~\ref{fig:ethanol-fit}.
The fitting results of the averaged running integral to the double exponential function (eq~\ref{eq:visc_fit}) with $1/t^b$ weight.
The inset shows the fitting results of the calculated standard deviation to the power function $\sigma(t) = Ae^b$.
The parameter $t_{cut}$ was found to be 700 ps in this case
which is the time at which the calculated standard deviation has the value of around 40\% of the viscosity 
(as shown by the flat region in the running integral).
The parameter b was found to be 0.52.
Results at other temperatures show similar behavior.

Figure~\ref{fig:ethanol-visc}.
Upper panel: The calculated viscosity of ethanol using the proposed time-decomposition method
and compared with experimental results.
The agreement with experimental results are reasonably well.
Experimental results: 
Exp. a, ref~\cite{Jouyban.KJCE.29.812.2012};
Exp. b, ref~\cite{Nain.JML.140.108.2008};
Exp. c, ref~\cite{Bhuiyan.JML.138.139.2008};
Exp. d, ref~\cite{Fonseca.JCED.52.1240.2007};
Exp. e, ref~\cite{Taboas.JCED.51.940.2006};
Exp. f, ref~\cite{Tojo.JCED.49.1590.2004}.
Lower panel: Comparison of the calculated viscosities with $t_{cut}=700 ps$ and $t_{cut}=2000 ps$.
Because of the average over multiple independent trajectories and the use of proper weighting function,
the results are not sensitive to the $t_{cut}$ value.
However, short $t_{cut}$ is preferred to save simulational time. 


Figure~\ref{fig:ethanol-num}.
The effect of number of independent trajectories on the calculated viscosity.
Results are shown for ethanol at 298 K, behavior at other temperatures are similar.
Upper left: the cumulative average of the running integral;
upper right: the calculated standard deviation for corresponding cumulative average (same color code);
lower left: the calculated standard deviation as a function of the number of independent trajectories at several time points;
lower right: calculated viscosity as a function of the number of independent trajectories,
the results with $1/t^{0.5}$ weight was also provided for comparison.
All plots shown that the results  converge with 40 or more independent trajectories.


Figure~\ref{fig:ethanol-length}.
The effect of length of each independent trajectory on the calculated viscosity.
Upper panel: the averaged running integral (over 100 independent trajectories) and the corresponding standard deviation;
lower panel: the calculated viscosity as a function of the number of independent trajectories.
When 4, 2 or 1 ns trajectories were used,
the calculated results are close to each other
and all converge with 40 trajectories although slightly larger fluctuations are seen when short trajectories were used.
When 500 ps trajectories were used,
the results show relatively large deviations from other results,
indicating the trajectories are probably too short.

Figure~\ref{fig:ethanol-boxsize}.
The effect of simulation system size on the calculated viscosity.
Systems containing 500, 1000 or 1500 ethanol molecules are used in the simulation.
Results are averages over 100 independent trajectories in each case.
The results show that,
because pressure and viscosity are collective properties,
the calculated running integral and the corresponding standard deviation are independent of the system size.
The calculated viscosities are within 1\% deviation from each other.

Figure~\ref{fig:bmim-ave}.
The calculated results using the time-decomposition method for $[BMIM][Tf_2N]$ at different temperatures.
All results are based on 100 independent trajectories.
Top panel: the calculated averaged running integral (eq~\ref{eq:gk});
middle panel: the calculated standard deviation (eq~\ref{eq:std_err});
bottom panel: the large fluctuation in the very short time region in the averaged running integral,
the same as the case in ethanol.

Figure~\ref{fig:bmim-visc}.
The calculated viscosity of $[BMIM][Tf_2N]$ using the proposed time-decomposition method
and compared with experimental results.
The calculated viscosities at high temperature were fitted to VTF equation
and extrapolated to low experimental temperatures.
The experimental results were also fitted to VTF equation
and extrapolated to the high temperature range.
The fitting results are shown in dashed lines.
The calculated viscosity agree with experimental results reasonably well.
Experimental results: 
Exp. a, ref~\cite{Gadzuric.JCED.57.1072.2012};
Exp. b, ref~\cite{Katsuta.JCED.55.1588.2010};
Exp. c, ref~\cite{Watanabe.JPCB.110.19593.2006};
Exp. d, ref~\cite{Majer.GC.8.172.2006};
Exp. e, ref~\cite{Watanabe.JPCB.109.6103.2005};
Exp. f, ref~\cite{VanderNoot.JEC.568.167.2004}.

Figure~\ref{fig:bmim-num}.
The effect of number of independent trajectories on the calculated viscosity.
Results are shown for $[BMIM][Tf_2N]$ at 350 K, behavior at other temperatures are similar.
The calculated viscosity converged with about 30 or more independent trajectories.
The results with $1/t^{0.5}$ weight were also provided for comparison.
Different from the almost exact agreement in the case of ethanol,
the difference between results with two weighting functions are slightly larger in this case
(but still $<$ 3\%),
likely due to the fact that the b parameters have values between 0.60-0.73
whereas the b parameters are close 0.5 for ethanol.




%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/03-nvt/visc-3.eps}
\caption{}
\label{fig:visc-longtraj}
\end{center}
\end{figure}

\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/post_analysis_BmimTf2n_Ethanol/density-2.eps}
%\\
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/post_analysis_BmimTf2n_Ethanol/density-1.eps}
\caption{}
\label{fig:density}
\end{center}
\end{figure}


%%%%%%%%%%%%%%%%%%%%% Ethanol
\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/visc-2.eps}
%\\
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/visc-1.eps}
\caption{}
\label{fig:ethanol-ave}
\end{center}
\end{figure}

\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/afs/crc.nd.edu/user/y/yzhang19/work/20-viscosity/02-C4C1im/04-nvt-swarm/350/ave/viscosity-2.eps}
\caption{}
\label{fig:t2weight}
\end{center}
\end{figure}


\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/visc-22.eps}
\caption{}
\label{fig:ethanol-2ps}
\end{center}
\end{figure}


\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/298/ave/viscosity-4.eps}
\caption{}
\label{fig:ethanol-fit}
\end{center}
\end{figure}


\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/post_analysis_BmimTf2n_Ethanol/visc-ethanol-1.eps}
%\\
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/post_analysis_BmimTf2n_Ethanol/visc-ethanol-3.eps}
\caption{}
\label{fig:ethanol-visc}
\end{center}
\end{figure}



\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/298/ave/viscosity-3.eps}
%\vspace{0.2in}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/visc-4.eps}
%\\
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/298/ave/standard_error/sigma-1.eps}
%\vspace{0.2in}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/298/visc-conv-1.eps}
\caption{}
\label{fig:ethanol-num}
\end{center}
\end{figure}


\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/298/viscosity-2.eps}
%\\
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/04-nvt-swarm/298/visc-conv-5.eps}
\caption{}
\label{fig:ethanol-length}
\end{center}
\end{figure}

\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/15-ethanol/viscosity-1.eps}
\caption{}
\label{fig:ethanol-boxsize}
\end{center}
\end{figure}


%%%%%%%%%%%%%%%%%%%%% BMIM/TF2N

\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/02-C4C1im/04-nvt-swarm/visc-2.eps}
%\\
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/02-C4C1im/04-nvt-swarm/visc-1.eps}
%\\
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/02-C4C1im/04-nvt-swarm/visc-22.eps}
\caption{}
\label{fig:bmim-ave}
\end{center}
\end{figure}


\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/post_analysis_BmimTf2n_Ethanol/visc-bmim-3.eps}
\caption{}
\label{fig:bmim-visc}
\end{center}
\end{figure}


\newpage
\clearpage
\begin{figure}
\begin{center}
%\includegraphics[angle=0,width=3.2in]{/pscratch/yzhang19/20-viscosity/02-C4C1im/04-nvt-swarm/350/visc-conv-1.eps}
\caption{}
\label{fig:bmim-num}
\end{center}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%



\end{document}
